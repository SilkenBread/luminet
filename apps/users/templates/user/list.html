{% extends 'body.html' %}
{% load static %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="{% static 'lib/datatables/datatables.min.css' %}">
{% endblock %}

{% block content_main %}
<div class="space-y-6">
    <!-- Header con título y botón de crear -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ title }}</h1>
            <p class="mt-1 text-sm text-gray-500">Gestiona los usuarios del sistema</p>
        </div>
        <a href="{{ create_url }}" 
           class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 shadow-sm">
            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
            Nuevo Usuario
        </a>
    </div>

    <!-- Card con tabla -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6">
            <div class="overflow-x-auto">
                <table id="usersTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Avatar
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Usuario
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Nombre Completo
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Email
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Teléfono
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Área
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Estado
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- DataTables cargará el contenido aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock content_main %}

{% block extra_body_content %}
<!-- DataTables JS -->
<script src="{% static 'lib/datatables/datatables.min.js' %}"></script>

<script>
$(document).ready(function() {
    // Inicializar DataTable
    var table = $('#usersTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: window.location.pathname,
            type: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            error: function(xhr, error, thrown) {
                console.error('Error loading data:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'No se pudieron cargar los datos',
                    icon: 'error',
                    confirmButtonColor: '#3b82f6'
                });
            }
        },
        columns: [
            {
                data: 'gradient',
                orderable: false,
                searchable: false,
                render: function(data, type, row) {
                    const initial = row.username.charAt(0).toUpperCase();
                    return `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-${data.from} to-${data.to} flex items-center justify-center text-white font-semibold shadow-md ring-2 ring-gray-200">${initial}</div>`;
                }
            },
            {
                data: 'username',
                render: function(data, type, row) {
                    return `<span class="font-medium text-gray-900">${data}</span>`;
                }
            },
            {
                data: 'full_name',
                render: function(data, type, row) {
                    return `<span class="text-gray-700">${data}</span>`;
                }
            },
            {
                data: 'email',
                render: function(data, type, row) {
                    return `<a href="mailto:${data}" class="text-blue-600 hover:text-blue-800 hover:underline">${data}</a>`;
                }
            },
            {
                data: 'phone_number',
                render: function(data, type, row) {
                    return data ? `<span class="text-gray-700">${data}</span>` : '<span class="text-gray-400">N/A</span>';
                }
            },
            {
                data: 'fk_area',
                render: function(data, type, row) {
                    return data ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${data}</span>` : '<span class="text-gray-400">N/A</span>';
                }
            },
            {
                data: 'is_active',
                render: function(data, type, row) {
                    if (data) {
                        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i>
                                    Activo
                                </span>`;
                    } else {
                        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <i data-lucide="x-circle" class="w-3 h-3 mr-1"></i>
                                    Inactivo
                                </span>`;
                    }
                }
            },
            {
                data: null,
                orderable: false,
                searchable: false,
                render: function(data, type, row) {
                    return `
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="editUser(${row.id})" 
                                    class="inline-flex items-center p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors duration-200"
                                    title="Editar usuario">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteUser(${row.id}, '${row.username}')" 
                                    class="inline-flex items-center p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-200"
                                    title="Eliminar usuario">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        language: {
            url: '{% static "lib/datatables/es-CO.json" %}',
            processing: '<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>'
        },
        pageLength: 10,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        order: [[1, 'asc']],
        responsive: true,
        drawCallback: function() {
            // Reinicializar iconos de Lucide después de dibujar la tabla
            lucide.createIcons();
        },
        dom: '<"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4"<"flex-1"f><"flex items-center gap-2"l>>rt<"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mt-4"<"text-sm text-gray-700"i><"flex justify-end"p>>'
    });

    // Personalizar el input de búsqueda
    $('.dataTables_filter input').addClass('px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm');
    $('.dataTables_filter label').addClass('flex items-center gap-2 text-sm font-medium text-gray-700');
    
    // Personalizar el selector de longitud
    $('.dataTables_length select').addClass('px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm');
    $('.dataTables_length label').addClass('flex items-center gap-2 text-sm font-medium text-gray-700');
});

// Función para editar usuario
function editUser(userId) {
    window.location.href = `{% url 'users:user_edit' 0 %}`.replace('0', userId);
}

// Función para eliminar usuario
function deleteUser(userId, username) {
    Swal.fire({
        title: '¿Está seguro?',
        html: `¿Desea eliminar al usuario <strong>${username}</strong>?<br><small class="text-gray-500">Esta acción no se puede deshacer</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            const deleteUrl = '{% url "users:user_delete" 0 %}'.replace('0', userId);
            $.ajax({
                url: deleteUrl,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            title: '¡Eliminado!',
                            text: response.message || 'El usuario ha sido eliminado correctamente',
                            icon: 'success',
                            confirmButtonColor: '#3b82f6',
                            timer: 2000
                        });
                        $('#usersTable').DataTable().ajax.reload();
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: response.message || 'No se pudo eliminar el usuario',
                            icon: 'error',
                            confirmButtonColor: '#3b82f6'
                        });
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'No se pudo eliminar el usuario';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    Swal.fire({
                        title: 'Error',
                        text: errorMessage,
                        icon: 'error',
                        confirmButtonColor: '#3b82f6'
                    });
                }
            });
        }
    });
}

// Función helper para obtener el CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock extra_body_content %}

